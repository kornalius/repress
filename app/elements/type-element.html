<link rel="import" href="theme.html">

<dom-module id="type-element">

  <template>
    <style include="app-theme">
      :host {
        margin: .25em;
      }
      #text {
        width: 100%;
      }
      #text > span {
        margin-right: .5em;
      }
      #cursor {
        background-color: var(--white-color);
        /* height: .3em; */
        height: 1em;
        width: .6em;
        margin-left: -.4em;
        /* margin-top: .7em; */
        transition: opacity 0.15s ease-out;
      }
      .visible {
        opacity: 1;
      }
      .hidden {
        opacity: 0;
      }
    </style>

    <div id="text" class="layout horizontal wrap">
      <div id="cursor"></div>
    </div>

  </template>

  <script>
    class TypeElement extends Polymer.Element {

      static get is() { return 'type-element'; }

      static get properties () {
        return {
          minSpeed: {
            type: Number,
            value: 25,
          },
          maxSpeed: {
            type: Number,
            value: 75,
          },
          cursorBlinkSpeed: {
            type: Number,
            value: 350,
          },
          autoStart: {
            type: Boolean,
            value: false,
          },
          text: {
            type: String,
            value: '',
          },
          _currentText: {
            type: String,
            value: '',
          },
        }
      }

      ready () {
        super.ready()

        this.clear()

        this.hideCursor()

        this.text = this.innerHTML

        if (this.autoStart) {
          this.start()
        }
      }

      connectedCallback () {
        super.connectedCallback()
      }

      start () {
        this.hideCursor()
        this._cursorInterval = setInterval(this.toggleCursor.bind(this), this.cursorBlinkSpeed)

        this.clear()
        this._stopped = false

        this._x = -1

        this.dispatchEvent(new CustomEvent('type-start'))

        this.type()
      }

      _newSpan () {
        this._span = document.createElement('span')
        this.$.text.insertBefore(this._span, this.$.cursor)
      }

      type () {
        setTimeout(() => {
          if (!this._span) {
            this._newSpan()
          }

          this._x++

          if (this._x < this.text.length) {
            let c = this.text[this._x]
            if (c === ' ' && !_.isEmpty(this._span.innerHTML)) {
              this._newSpan()
            }
            else {
              this._span.innerHTML += c
            }
            this.showCursor()

            let s = 'key' + _.random(1, 3);
            let id = Repress.sounds.play(s)
            Repress.sounds.volume(s, _.random(0.25, 0.75, true), id)

            let delay = 0
            if (!/\w/.test(c)) {
              delay = _.random(this.minSpeed, this.maxSpeed * (c === '.' ? 3 : 1))
            }

            this.dispatchEvent(new CustomEvent('type-char', {
              bubbles: true,
              detail: {
                char: c
              }
            }))

            if (!this._stopped) {
              setTimeout(() => {
                this.type()
              }, delay)
            }
          }
          else {
            this.stop()
          }
        }, _.random(this.minSpeed, this.maxSpeed))
      }

      stop () {
        clearInterval(this._cursorInterval)
        this._span = undefined
        this.hideCursor()

        this._stopped = true

        this.dispatchEvent(new CustomEvent('type-done'))
      }

      clear () {
        let spans = this.$.text.querySelectorAll('span')
        for (var span of spans) {
          span.parentNode.removeChild(span)
        }
        this._span = undefined
      }

      get isCursorVisible () {
        return this.$.cursor.className === 'visible'
      }

      showCursor () {
        this.$.cursor.className = 'visible'
      }

      hideCursor () {
        this.$.cursor.className = 'hidden'
      }

      toggleCursor () {
        if (this.isCursorVisible) {
          this.hideCursor()
        }
        else {
          this.showCursor()
        }
      }

    }

    customElements.define(TypeElement.is, TypeElement);
  </script>

</dom-module>
